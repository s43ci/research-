<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واثِق - نظام جمع البيانات الذكي</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #2980b9;
            --accent: #27ae60;
            --bg: #f0f2f5;
            --white: #ffffff;
            --error: #e74c3c;
            --warning: #f39c12;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--primary);
            line-height: 1.6;
            padding-bottom: 80px; /* مساحة للأزرار العائمة في الموبايل */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        /* شريط التحكم العلوي */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .settings-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .settings-group input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .reset-btn {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* شريط التقدم */
        .progress-header {
            background: linear-gradient(45deg, var(--secondary), #3498db);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* تصميم الأسئلة */
        .question-block {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e1e4e8;
            border-radius: 10px;
            background: #fff;
            transition: all 0.3s ease;
        }

        .question-block.unanswered {
            border: 2px solid var(--error);
            background-color: #fdf2f2;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .q-text {
            font-weight: 700;
            margin-bottom: 15px;
            display: block;
            font-size: 1.05em;
        }

        /* تكبير مساحة الضغط */
        .options-grid label {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .options-grid label:hover {
            background: #e9ecef;
        }

        /* ستايل عند الاختيار */
        .options-grid input[type="radio"]:checked + span {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .options-grid input[type="radio"]:checked + span::before {
             /* يمكن إضافة أيقونة هنا */
        }

        .options-grid label:has(input:checked) {
            background-color: #eaf6ff;
            border-color: var(--secondary);
        }

        input[type="radio"] {
            transform: scale(1.5);
            margin-left: 15px;
            accent-color: var(--secondary);
        }

        /* أزرار التحكم السفلية */
        .action-bar {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            flex: 1;
        }

        .btn:active { transform: scale(0.98); }

        .btn-next { background-color: var(--secondary); color: white; }
        .btn-prev { background-color: #95a5a6; color: white; }
        .btn-clear { background-color: #e74c3c; color: white; opacity: 0.8; max-width: 150px;}

        /* قسم التصدير */
        #export-section {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .success-icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .export-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            padding: 15px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-excel { background-color: #217346; }
        .btn-word { background-color: #2b579a; }

        /* رسائل التنبيه */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div>
            <h2 style="margin:0; color:var(--primary);">نظام واثِق</h2>
        </div>
        
        <div class="settings-group">
            <label for="target-samples">عدد العينات الكلي:</label>
            <input type="number" id="target-samples" value="40" min="2" onchange="updateTargetSamples()">
        </div>

        <button class="reset-btn" onclick="hardReset()">⚠️ تصفير وبدء جديد</button>
    </div>

    <div id="survey-view">
        <div class="progress-header">
            <span>عينة رقم: <span id="current-display" style="font-size:1.4em; color:#fff;">1</span></span>
            <span style="font-size:0.8em; opacity:0.9;">من أصل <span id="total-display">40</span></span>
        </div>

        <form id="mainForm">
            <div id="questions-area"></div>
        </form>

        <div class="action-bar">
            <button class="btn btn-prev" onclick="prevSample()" id="btn-prev" disabled>السابق</button>
            <button class="btn btn-clear" onclick="clearCurrentSample()">مسح العينة</button>
            <button class="btn btn-next" onclick="nextSample()" id="btn-next">التالي وحفظ</button>
        </div>
    </div>

    <div id="export-section">
        <div class="success-icon">✔</div>
        <h2>تم إكمال جميع العينات بنجاح!</h2>
        <p>البيانات جاهزة للتصدير</p>
        
        <button class="export-btn btn-excel" onclick="exportExcel()">تحميل ملف Excel (.xlsx)</button>
        <button class="export-btn btn-word" onclick="exportWord()">تحميل ملف Word (.docx)</button>
        <br>
        <button class="btn btn-prev" onclick="returnToSurvey()" style="background:#7f8c8d; max-width:200px;">عودة لمراجعة البيانات</button>
    </div>
</div>

<div id="toast" class="toast">تم الحفظ تلقائياً</div>

<script>
    // --- هيكلية البيانات والأسئلة ---
    // 0 = المجموعة الأولى (نعم/صح...)
    // 1 = المجموعة الثانية (لا/خطأ...)
    // 2 = المجموعة الثالثة (أحياناً/لا أعلم...)
    const structure = [
        {
            title: "القسم الأول: البيانات الديموغرافية",
            qs: [
                {t:"1. العمر:", o:["أقل من 20 سنة", "20 - 29 سنة", "30 - 39 سنة", "40 سنة فأكثر"]},
                {t:"2. المستوى التعليمي:", o:["أمية", "ابتدائية", "متوسطة", "إعدادية", "جامعية فأعلى"]},
                {t:"3. الحالة الوظيفية:", o:["ربة بيت", "موظفة", "عاملة / أخرى"]},
                {t:"4. عدد مرات الحمل السابقة:", o:["حمل واحد", "2 - 3 مرات", "أكثر من 3 مرات"]},
                {t:"5. هل سبق لكِ التعرض لولادة مبكرة؟", o:["نعم", "لا"]}
            ]
        },
        {
            title: "القسم الثاني: مستوى المعرفة",
            qs: [
                {t:"1. الولادة المبكرة تحدث قبل الأسبوع 37:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"2. قلة المتابعة الطبية تزيد الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"3. فقر الدم قد يؤدي للولادة المبكرة:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"4. الالتهابات البولية تسبب ولادة مبكرة:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"5. التدخين يزيد الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"6. الولادة المبكرة لا تؤثر على المولود:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"7. ارتفاع الضغط من عوامل الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"8. التغذية الجيدة تقلل الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"9. الحمل المتقارب يزيد الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"10. الإجهاد النفسي قد يؤدي لولادة مبكرة:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"11. المتابعة المبكرة تقلل المضاعفات:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"12. النزف المهبلي مؤشر خطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"13. سوء التغذية يزيد الخطر:", o:["صح", "خطأ", "لا أعلم"]},
                {t:"14. الراحة ليس لها دور (نفي):", o:["صح", "خطأ", "لا أعلم"]},
                {t:"15. المتابعة المنتظمة تكتشف العلامات مبكراً:", o:["صح", "خطأ", "لا أعلم"]}
            ]
        },
        {
            title: "القسم الثالث: الالتزام بالمراجعات",
            qs: [
                {t:"1. هل تلتزمين بالمراجعات الدورية؟", o:["دائماً", "لا ألتزم", "أحياناً"]}, // ترتيب القيم 0,1,2 حسب طلبك
                {t:"2. كم مرة تراجعين؟", o:["حسب التعليمات", "أقل من المطلوب", "عند التعب فقط"]},
                {t:"3. إجراء الفحوصات المطلوبة؟", o:["نعم دائماً", "لا", "أحياناً"]},
                {t:"4. هل يشرح لك الكادر المخاطر؟", o:["نعم", "لا", "أحياناً"]},
                {t:"5. هل المراجعات تقلل الخطر؟", o:["نعم", "لا", "لا أعلم"]},
                {t:"6. سبب عدم الانتظام؟", o:["بعد/وقت", "قلة وعي", "مادية"]},
                {t:"7. متى بدأت أول مراجعة؟", o:["الثلث الأول", "الثلث الثاني", "الثلث الثالث"]},
                {t:"8. الالتزام بتعليمات الطبيب؟", o:["نعم دائماً", "لا", "أحياناً"]},
                {t:"9. قياس ضغط الدم بانتظام؟", o:["نعم", "لا", "أحياناً"]},
                {t:"10. متابعة الهيموغلوبين؟", o:["نعم", "لا", "أحياناً"]},
                {t:"11. مراجعة فور الأعراض؟", o:["نعم", "لا", "أحياناً"]},
                {t:"12. حصلتِ على تثقيف صحي؟", o:["نعم", "لا", "أحياناً"]}
            ]
        }
    ];

    // --- إدارة الحالة (State Management) ---
    let appState = {
        target: 40,
        currentIdx: 0, // يبدأ من 0 (يعني العينة 1)
        data: [] // مصفوفة تخزن كائنات البيانات
    };

    // عند التحميل
    window.onload = function() {
        loadState();
        renderForm();
        updateUI();
    };

    // --- Local Storage Functions ---
    function saveState() {
        localStorage.setItem('wathiq_v2_state', JSON.stringify(appState));
        showToast();
    }

    function loadState() {
        const saved = localStorage.getItem('wathiq_v2_state');
        if (saved) {
            appState = JSON.parse(saved);
            document.getElementById('target-samples').value = appState.target;
        } else {
            // تهيئة مصفوفة فارغة بحجم العدد المستهدف
            initEmptyData(40);
        }
    }

    function initEmptyData(size) {
        // التأكد من أن المصفوفة بحجم العدد المطلوب
        if (appState.data.length < size) {
            for (let i = appState.data.length; i < size; i++) {
                appState.data.push({}); // كائن فارغ لكل عينة
            }
        }
        appState.target = size;
    }

    function hardReset() {
        if(confirm("هل أنت متأكد؟ سيتم حذف جميع البيانات والبدء من جديد!")) {
            localStorage.removeItem('wathiq_v2_state');
            location.reload();
        }
    }

    // --- Core Logic ---
    function updateTargetSamples() {
        const newVal = parseInt(document.getElementById('target-samples').value);
        if (newVal < 2) return;
        appState.target = newVal;
        initEmptyData(newVal);
        updateUI(); // لتحديث العداد
        saveState();
    }

    function renderForm() {
        const container = document.getElementById('questions-area');
        container.innerHTML = '';
        let globalQIndex = 1; // لترقيم الـ ID

        structure.forEach((section, sIdx) => {
            const secDiv = document.createElement('div');
            secDiv.innerHTML = `<div class="section-title" style="background:#eee; padding:10px; border-radius:5px; margin-top:20px; font-weight:bold;">${section.title}</div>`;
            
            section.qs.forEach((q, qIdx) => {
                const qKey = `q${globalQIndex}`; // مفتاح السؤال الفريد
                const qBlock = document.createElement('div');
                qBlock.className = 'question-block';
                qBlock.id = `block_${qKey}`;

                let optionsHTML = '';
                q.o.forEach((optText, optVal) => {
                    // التحقق مما إذا كانت هناك قيمة محفوظة
                    const savedVal = appState.data[appState.currentIdx] ? appState.data[appState.currentIdx][qKey] : undefined;
                    const isChecked = (savedVal === optVal) ? 'checked' : '';

                    optionsHTML += `
                        <label>
                            <input type="radio" name="${qKey}" value="${optVal}" ${isChecked} onchange="autoSaveField('${qKey}', ${optVal})">
                            <span>${optText}</span>
                        </label>
                    `;
                });

                qBlock.innerHTML = `
                    <span class="q-text">${q.t}</span>
                    <div class="options-grid">${optionsHTML}</div>
                `;
                secDiv.appendChild(qBlock);
                globalQIndex++;
            });
            container.appendChild(secDiv);
        });
    }

    function autoSaveField(key, value) {
        if (!appState.data[appState.currentIdx]) {
            appState.data[appState.currentIdx] = {};
        }
        appState.data[appState.currentIdx][key] = value;
        saveState();
        
        // إزالة التنبيه الأحمر إذا تم الحل
        document.getElementById(`block_${key}`).classList.remove('unanswered');
    }

    function updateUI() {
        document.getElementById('current-display').innerText = appState.currentIdx + 1;
        document.getElementById('total-display').innerText = appState.target;
        
        // التحكم في الأزرار
        document.getElementById('btn-prev').disabled = (appState.currentIdx === 0);
        
        const nextBtn = document.getElementById('btn-next');
        if (appState.currentIdx === appState.target - 1) {
            nextBtn.innerText = "إنهاء وتصدير";
            nextBtn.style.backgroundColor = "#27ae60";
        } else {
            nextBtn.innerText = "التالي وحفظ";
            nextBtn.style.backgroundColor = ""; // العودة للافتراضي CSS
        }
    }

    function nextSample() {
        if (validateCurrentSample()) {
            if (appState.currentIdx < appState.target - 1) {
                appState.currentIdx++;
                renderForm(); // إعادة رسم الفورم للعينة الجديدة
                updateUI();
                window.scrollTo(0, 0);
                saveState();
            } else {
                showExport();
            }
        }
    }

    function prevSample() {
        if (appState.currentIdx > 0) {
            appState.currentIdx--;
            renderForm();
            updateUI();
            window.scrollTo(0, 0);
            saveState();
        }
    }

    function clearCurrentSample() {
        if(confirm("هل تريد مسح إجابات هذه العينة فقط؟")) {
            appState.data[appState.currentIdx] = {};
            renderForm();
            saveState();
        }
    }

    function validateCurrentSample() {
        const currentData = appState.data[appState.currentIdx] || {};
        let totalQuestions = 32; // إجمالي الأسئلة
        let firstMissing = null;

        // إزالة أي تنبيهات سابقة
        document.querySelectorAll('.question-block').forEach(b => b.classList.remove('unanswered'));

        for (let i = 1; i <= totalQuestions; i++) {
            const key = `q${i}`;
            if (currentData[key] === undefined) {
                const block = document.getElementById(`block_${key}`);
                block.classList.add('unanswered');
                if (!firstMissing) firstMissing = block;
            }
        }

        if (firstMissing) {
            // التمرير الذكي للسؤال الناقص
            firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
        return true;
    }

    // --- Export Logic ---
    function showExport() {
        document.getElementById('survey-view').style.display = 'none';
        document.getElementById('export-section').style.display = 'block';
    }

    function returnToSurvey() {
        document.getElementById('survey-view').style.display = 'block';
        document.getElementById('export-section').style.display = 'none';
    }

    function prepareDataForExport() {
        return appState.data.slice(0, appState.target).map((item, index) => {
            let row = { 'ID': index + 1 };
            for(let i=1; i<=32; i++) {
                row[`Q${i}`] = (item[`q${i}`] !== undefined) ? item[`q${i}`] : ''; 
            }
            return row;
        });
    }

    function exportExcel() {
        const data = prepareDataForExport();
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, "Wathiq_Results.xlsx");
    }

    function exportWord() {
        const data = prepareDataForExport();
        let html = `<h2 style='text-align:center'>بيانات مشروع واثق</h2>`;
        html += `<table border="1" style="border-collapse: collapse; width: 100%; direction: rtl; text-align: center;">`;
        
        // Header
        html += `<tr style="background:#ddd;"><th>العيّنة</th>`;
        for(let i=1; i<=32; i++) html += `<th>س${i}</th>`;
        html += `</tr>`;

        // Body
        data.forEach(row => {
            html += `<tr><td>${row['ID']}</td>`;
            for(let i=1; i<=32; i++) {
                html += `<td>${row[`Q${i}`] !== '' ? row[`Q${i}`] : '-'}</td>`;
            }
            html += `</tr>`;
        });
        html += `</table>`;

        const blob = new Blob(['\ufeff', html], {
            type: 'application/msword'
        });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Wathiq_Results.doc'; // .doc يفتح بسهولة في وورد
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1000);
    }

</script>
</body>
</html>
