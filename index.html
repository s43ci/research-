<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ§Ø«ÙÙ‚ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© ÙÙ‚Ø·</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #8e44ad; /* Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ù…Ù…ÙŠØ² Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠ */
            --bg: #f3f0f5;
            --white: #ffffff;
            --error: #c0392b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--primary);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            min-height: 400px;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 0;
            text-align: center;
        }

        .input-group-start {
            margin: 30px 0;
            background: #e8daef;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 300px;
        }

        .input-group-start input {
            width: 80%;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            border: 2px solid var(--secondary);
            border-radius: 5px;
            margin-top: 10px;
        }

        .btn-start {
            background-color: var(--secondary);
            color: white;
            padding: 15px 50px;
            font-size: 1.2em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);
        }

        .btn-start:hover { transform: scale(1.05); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† */
        #survey-view { display: none; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-header {
            background: linear-gradient(135deg, var(--secondary), #9b59b6);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            font-weight: bold;
        }

        /* Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .section-title {
            background: #f4ecf7;
            color: var(--secondary);
            padding: 12px;
            border-radius: 8px;
            margin-top: 25px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.1em;
            border-right: 5px solid var(--secondary);
        }

        .question-block {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
        }

        .question-block.unanswered {
            border: 2px solid var(--error);
            background-color: #fff5f5;
        }

        .q-text {
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
        }

        .options-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .options-grid label {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 auto; /* ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØªÙ…Ø¯Ø¯ Ø¨Ø´ÙƒÙ„ Ù…ØªÙ†Ø§Ø³Ù‚ */
        }

        .options-grid label:hover { background: #f4ecf7; border-color: var(--secondary); }

        .options-grid input[type="radio"] { accent-color: var(--secondary); transform: scale(1.2); }

        /* Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
        .options-grid label:has(input:checked) {
            background-color: #e8daef;
            color: var(--secondary);
            border-color: var(--secondary);
            font-weight: bold;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            font-size: 16px;
        }

        .btn-next { background-color: var(--primary); color: white; }
        .btn-prev { background-color: #95a5a6; color: white; }
        .btn-clear { background-color: #e74c3c; color: white; flex: 0 0 100px; }

        /* Ø§Ù„ØªØµØ¯ÙŠØ± */
        #export-section { display: none; text-align: center; padding: 40px; }
        .btn-excel { background-color: #217346; color: white; width: 100%; margin-bottom: 10px; padding: 15px;}
        .btn-word { background-color: #2b579a; color: white; width: 100%; padding: 15px;}

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 25px;
            border-radius: 50px;
            display: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="welcome-screen">
        <h1 style="color:var(--secondary)">ÙˆØ§Ø«ÙÙ‚</h1>
        <h3>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ©</h3>
        
        <div class="input-group-start">
            <label for="start-count">Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ:</label>
            <input type="number" id="start-count" value="40" min="1">
        </div>

        <button class="btn-start" onclick="startSurvey()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</button>
    </div>

    <div id="survey-view">
        <div class="progress-header">
            <button onclick="hardReset()" style="background:transparent; border:none; color:white; font-size:0.8em; cursor:pointer;">âš ï¸ ØªØµÙÙŠØ±</button>
            <span>Ø¹ÙŠÙ†Ø©: <span id="current-display" style="font-size:1.4em;">1</span> Ù…Ù† <span id="total-display">40</span></span>
        </div>

        <form id="mainForm">
            <div id="questions-area"></div>
        </form>

        <div class="action-bar">
            <button class="btn btn-prev" onclick="prevSample()" id="btn-prev" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btn-clear" onclick="clearCurrentSample()">Ù…Ø³Ø­</button>
            <button class="btn btn-next" onclick="nextSample()" id="btn-next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
    </div>

    <div id="export-section">
        <h2 style="color:var(--secondary)">ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†!</h2>
        <p>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø­ÙØ¸</p>
        <button class="btn btn-excel" onclick="exportExcel()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel (.xlsx)</button>
        <button class="btn btn-word" onclick="exportWord()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Word (.docx)</button>
        <br><br>
        <button class="btn btn-prev" onclick="returnToSurvey()" style="background:#7f8c8d; width: auto;">Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    </div>
</div>

<div id="toast" class="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…</div>

<script>
    // --- Ù‡ÙŠÙƒÙ„ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© ÙÙ‚Ø·) ---
    const structure = [
        {
            title: "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ©",
            qs: [
                {t:"1. Ø§Ù„Ø¬Ù†Ø³:", o:["Ø°ÙƒØ±", "Ø£Ù†Ø«Ù‰"]},
                {t:"2. Ø§Ù„Ø¹Ù…Ø±:", o:["20-29 Ø³Ù†Ø©", "30-39 Ø³Ù†Ø©", "40-49 Ø³Ù†Ø©", "50 ÙØ£ÙƒØ«Ø±"]},
                {t:"3. Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ù„Ù…ÙŠ:", o:["Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©", "Ù…Ø¹Ù‡Ø¯", "ÙƒÙ„ÙŠØ©", "Ø¯Ø±Ø§Ø³Ø§Øª Ø¹Ù„ÙŠØ§"]},
                {t:"4. Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø²ÙˆØ¬ÙŠØ©:", o:["Ø£Ø¹Ø²Ø¨ / Ø¹Ø²Ø¨Ø§Ø¡", "Ù…ØªØ²ÙˆØ¬ / Ù…ØªØ²ÙˆØ¬Ø©", "Ù…Ø·Ù„Ù‚ / Ù…Ø·Ù„Ù‚Ø©", "Ø£Ø±Ù…Ù„ / Ø£Ø±Ù…Ù„Ø©"]},
                {t:"5. Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¯Ù…Ø©:", o:["Ø£Ù‚Ù„ Ù…Ù† 5 Ø³Ù†ÙˆØ§Øª", "5-9 Ø³Ù†ÙˆØ§Øª", "10-14 Ø³Ù†Ø©", "15-19 Ø³Ù†Ø©", "20-24 Ø³Ù†Ø©", "25 Ø³Ù†Ø© ÙØ£ÙƒØ«Ø±"]},
                {t:"6. Ù‡Ù„ Ø§Ø´ØªØ±ÙƒØª ÙÙŠ Ø¯ÙˆØ±Ø§Øª Ø¹Ù„Ø§Ø¬ Ø§Ù„Ø£ÙˆØ±Ø§Ù…ØŸ", o:["Ù†Ø¹Ù…", "Ù„Ø§"]},
                {t:"7. Ù…Ø¯Ø© Ø§Ù„Ø¯ÙˆØ±Ø© (Ø§Ø®ØªØ± Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø§):", o:["3-5 Ø£ÙŠØ§Ù…", "6-10 Ø£ÙŠØ§Ù…", "11 ÙŠÙˆÙ… ÙØ£ÙƒØ«Ø±", "Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"]},
                {t:"8. Ù…ÙƒØ§Ù† Ø§Ù„Ø¯ÙˆØ±Ø© (Ø§Ø®ØªØ± Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø§):", o:["Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©", "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©", "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø·Ø±", "Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"]}
            ]
        }
    ];

    let appState = {
        target: 40,
        currentIdx: 0,
        data: []
    };

    // --- Start Logic ---
    window.onload = function() {
        const saved = localStorage.getItem('wathiq_demo_only_v1');
        if (saved) {
            appState = JSON.parse(saved);
            showSurveyInterface();
        }
    };

    function startSurvey() {
        const countInput = document.getElementById('start-count').value;
        const count = parseInt(countInput);
        if (count && count > 0) {
            appState.target = count;
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµÙÙˆÙØ©
            for(let i=0; i<count; i++) appState.data.push({});
            saveState();
            showSurveyInterface();
        } else {
            alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 0");
        }
    }

    function showSurveyInterface() {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('survey-view').style.display = 'block';
        updateUI();
        renderForm();
    }

    // --- Render & Logic ---
    function renderForm() {
        const container = document.getElementById('questions-area');
        container.innerHTML = '';
        let globalQIndex = 1;

        structure.forEach((section) => {
            const secDiv = document.createElement('div');
            secDiv.innerHTML = `<div class="section-title">${section.title}</div>`;
            
            section.qs.forEach((q) => {
                const qKey = `q${globalQIndex}`;
                const qBlock = document.createElement('div');
                qBlock.className = 'question-block';
                qBlock.id = `block_${qKey}`;

                let optionsHTML = '';
                q.o.forEach((optText, optIdx) => {
                    const savedVal = appState.data[appState.currentIdx] ? appState.data[appState.currentIdx][qKey] : undefined;
                    const isChecked = (savedVal === optIdx) ? 'checked' : '';

                    optionsHTML += `
                        <label>
                            <input type="radio" name="${qKey}" value="${optIdx}" ${isChecked} onchange="autoSaveField('${qKey}', ${optIdx})">
                            ${optText}
                        </label>
                    `;
                });

                qBlock.innerHTML = `
                    <span class="q-text">${q.t}</span>
                    <div class="options-grid">${optionsHTML}</div>
                `;
                secDiv.appendChild(qBlock);
                globalQIndex++;
            });
            container.appendChild(secDiv);
        });
        window.scrollTo(0,0);
    }

    function autoSaveField(key, value) {
        if (!appState.data[appState.currentIdx]) appState.data[appState.currentIdx] = {};
        appState.data[appState.currentIdx][key] = value;
        saveState();
        document.getElementById(`block_${key}`).classList.remove('unanswered');
    }

    function nextSample() {
        if (validateCurrentSample()) {
            if (appState.currentIdx < appState.target - 1) {
                appState.currentIdx++;
                saveState();
                renderForm();
                updateUI();
                showToast();
            } else {
                saveState();
                showExport();
            }
        }
    }

    function prevSample() {
        if (appState.currentIdx > 0) {
            appState.currentIdx--;
            saveState();
            renderForm();
            updateUI();
        }
    }

    function validateCurrentSample() {
        const currentData = appState.data[appState.currentIdx] || {};
        let totalQuestions = 8; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© ÙÙ‚Ø·
        let firstMissing = null;

        document.querySelectorAll('.question-block').forEach(b => b.classList.remove('unanswered'));

        for (let i = 1; i <= totalQuestions; i++) {
            const key = `q${i}`;
            if (currentData[key] === undefined) {
                const block = document.getElementById(`block_${key}`);
                block.classList.add('unanswered');
                if (!firstMissing) firstMissing = block;
            }
        }

        if (firstMissing) {
            firstMissing.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
        return true;
    }

    function updateUI() {
        document.getElementById('current-display').innerText = appState.currentIdx + 1;
        document.getElementById('total-display').innerText = appState.target;
        document.getElementById('btn-prev').disabled = (appState.currentIdx === 0);
        
        const nextBtn = document.getElementById('btn-next');
        if (appState.currentIdx === appState.target - 1) {
            nextBtn.innerText = "Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØªØµØ¯ÙŠØ±";
            nextBtn.style.backgroundColor = "#27ae60";
        } else {
            nextBtn.innerText = "Ø§Ù„ØªØ§Ù„ÙŠ";
            nextBtn.style.backgroundColor = ""; 
        }
    }

    function clearCurrentSample() {
        if(confirm("Ù…Ø³Ø­ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù‡Ø°Ù‡ Ø§Ù„Ø¹ÙŠÙ†Ø©ØŸ")) {
            appState.data[appState.currentIdx] = {};
            renderForm();
            saveState();
        }
    }

    function saveState() {
        localStorage.setItem('wathiq_demo_only_v1', JSON.stringify(appState));
    }

    function hardReset() {
        if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©!")) {
            localStorage.removeItem('wathiq_demo_only_v1');
            location.reload();
        }
    }

    function showToast() {
        const t = document.getElementById('toast');
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1000);
    }

    // --- Export ---
    function showExport() {
        document.getElementById('survey-view').style.display = 'none';
        document.getElementById('export-section').style.display = 'block';
    }

    function returnToSurvey() {
        document.getElementById('survey-view').style.display = 'block';
        document.getElementById('export-section').style.display = 'none';
    }

    function prepareData() {
        return appState.data.slice(0, appState.target).map((item, idx) => {
            let row = { 'ID': idx + 1 };
            // ÙÙ‚Ø· 8 Ø£Ø³Ø¦Ù„Ø©
            for(let i=1; i<=8; i++) {
                row[`Q${i}`] = (item[`q${i}`] !== undefined) ? item[`q${i}`] : ''; 
            }
            return row;
        });
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(prepareData());
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Demographics");
        XLSX.writeFile(wb, "Demographics_Data.xlsx");
    }

    function exportWord() {
        const data = prepareData();
        let html = `<table border="1" style="border-collapse: collapse; text-align: center; width:100%; direction:rtl;">`;
        html += `<tr style="background:#eee;"><th>Øª</th>`;
        // Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨
        const headers = ["Ø§Ù„Ø¬Ù†Ø³", "Ø§Ù„Ø¹Ù…Ø±", "Ø§Ù„ØªØ¹Ù„ÙŠÙ…", "Ø­.Ø²ÙˆØ¬ÙŠØ©", "Ø§Ù„Ø®Ø¯Ù…Ø©", "Ø¯ÙˆØ±Ø§ØªØŸ", "Ø§Ù„Ù…Ø¯Ø©", "Ø§Ù„Ù…ÙƒØ§Ù†"];
        headers.forEach(h => html += `<th>${h}</th>`);
        html += `</tr>`;
        
        data.forEach(row => {
            html += `<tr><td>${row['ID']}</td>`;
            for(let i=1; i<=8; i++) html += `<td>${row[`Q${i}`] !== '' ? row[`Q${i}`] : '-'}</td>`;
            html += `</tr>`;
        });
        html += `</table>`;
        
        const blob = new Blob(['\ufeff', `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>${html}</body></html>`], {type: 'application/msword'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'Demographics_Data.doc';
        link.click();
    }
</script>

</body>
</html>
